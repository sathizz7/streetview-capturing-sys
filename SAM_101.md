# AWS SAM Template 101: Security Best Practices

This guide explains how to write a **secure** AWS SAM (Serverless Application Model) template and configuration file, using a simplified single-handler example.

---

## Table of Contents
1. [Project Structure](#project-structure)
2. [Security Best Practices](#security-best-practices)
3. [Skeleton Template](#skeleton-template-templateyaml)
4. [Configuration File](#configuration-file-samconfigtoml)
5. [Deployment Commands](#deployment-commands)

---

## Project Structure

```
my-serverless-app/
├── template.yaml          # SAM Template (Infrastructure as Code)
├── samconfig.toml         # Deployment configuration
├── requirements.txt       # Python dependencies
└── src/
    └── handler.py         # Lambda function code
```

---

## Security Best Practices

### 1. Never Hardcode Secrets
❌ **Bad**: Embedding API keys directly in template or code.
```yaml
Environment:
  Variables:
    API_KEY: "sk-1234567890abcdef"  # NEVER DO THIS
```

✅ **Good**: Use AWS Secrets Manager with dynamic resolution.
```yaml
Environment:
  Variables:
    API_KEY: !Sub "{{resolve:secretsmanager:${SecretName}:SecretString:API_KEY}}"
```

### 2. Use `NoEcho` for Sensitive Parameters
If you must pass secrets as parameters (e.g., for local testing), use `NoEcho: true` to prevent them from appearing in CloudFormation console logs.
```yaml
Parameters:
  MyApiKey:
    Type: String
    NoEcho: true
    Description: API Key (hidden from logs)
```

### 3. Principle of Least Privilege for IAM
Grant only the permissions your Lambda needs. Avoid `Resource: "*"` unless absolutely necessary.
```yaml
Policies:
  - Version: "2012-10-17"
    Statement:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
        Resource: !GetAtt MyTable.Arn  # Scoped to specific table
```

### 4. Enable VPC (Optional but Recommended for Production)
Use conditional VPC attachment for sensitive workloads.
```yaml
Conditions:
  UseVpc: !Equals [!Ref EnableVpc, "true"]

Globals:
  Function:
    VpcConfig:
      SecurityGroupIds:
        - Fn::If: [UseVpc, !Ref SecurityGroupId, !Ref "AWS::NoValue"]
      SubnetIds:
        - Fn::If: [UseVpc, !Ref SubnetId, !Ref "AWS::NoValue"]
```

### 5. Use Environment Tags
Tag all resources for cost tracking and security audits.
```yaml
Tags:
  Environment: !Ref EnvironmentName
  Application: my-app
  Owner: team-name
```

### 6. Configure CORS Securely
Avoid `AllowOrigin: "*"` in production. Specify allowed domains.
```yaml
Cors:
  AllowOrigin: "'https://myapp.example.com'"
  AllowMethods: "'GET,POST'"
  AllowHeaders: "'Content-Type,Authorization'"
```

### 7. Do NOT Create IAM Roles/Policies in SAM Templates
In enterprise environments, IAM resources should be managed centrally by security/platform teams. SAM templates should **reference existing IAM roles** via ARN parameters, not create them inline.

❌ **Bad**: Creating IAM role inside template.
```yaml
Resources:
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    # ... inline policy definitions
```

✅ **Good**: Reference a pre-created role via parameter.
```yaml
Parameters:
  LambdaRoleArn:
    Type: String
    Description: ARN of pre-created Lambda execution role

Resources:
  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      Role: !Ref LambdaRoleArn  # Use existing role
```

> [!IMPORTANT]
> This separation of concerns ensures:
> - Developers cannot accidentally grant excessive permissions.
> - Security teams maintain control over IAM policies.
> - Compliance with least-privilege principles.

---

## Skeleton Template (`template.yaml`)

Below is a minimal, secure SAM template for a single Lambda function with API Gateway.

```yaml
AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31

Description: >
  Secure SAM Template - Single Handler Example

# ============================================================
# PARAMETERS
# ============================================================
Parameters:
  EnvironmentName:
    Type: String
    AllowedValues: [dev, uat, prod]
    Default: dev

  SecretName:
    Type: String
    Description: AWS Secrets Manager secret name
    Default: my-app-secrets

  LambdaRoleArn:
    Type: String
    Description: ARN of pre-created Lambda execution role (managed by security team)

  AllowedOrigin:
    Type: String
    Description: CORS allowed origin
    Default: "*"

# ============================================================
# GLOBALS (Applied to all functions)
# ============================================================
Globals:
  Function:
    Timeout: 30
    MemorySize: 256
    Runtime: python3.12
    Tags:
      Environment: !Ref EnvironmentName
      Application: my-secure-app
    Environment:
      Variables:
        # Secure: Resolved at deploy time from Secrets Manager
        API_KEY: !Sub "{{resolve:secretsmanager:${SecretName}:SecretString:API_KEY}}"

# ============================================================
# RESOURCES
# ============================================================
Resources:

  # NOTE: IAM Role is NOT created here.
  # It must be pre-created by security/platform team and passed via LambdaRoleArn parameter.

  # API Gateway
  MyApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub "my-api-${EnvironmentName}"
      StageName: !Ref EnvironmentName
      Cors:
        AllowOrigin: !Sub "'${AllowedOrigin}'"
        AllowMethods: "'GET,POST,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization'"

  # Lambda Function
  MyHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "MyHandler-${EnvironmentName}"
      CodeUri: .
      Handler: src/handler.lambda_handler
      Role: !Ref LambdaRoleArn  # Reference external role (not created in this template)
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /process
            Method: POST

# ============================================================
# OUTPUTS
# ============================================================
Outputs:
  ApiEndpoint:
    Description: API Gateway URL
    Value: !Sub "https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/${EnvironmentName}"
```

---

## Configuration File (`samconfig.toml`)

The `samconfig.toml` stores deployment settings per environment. **Never commit secrets here.**

```toml
version = 0.1

[default.global.parameters]
stack_name = "my-secure-app"

[default.build.parameters]
cached = true
parallel = true

# ============================================================
# DEV ENVIRONMENT
# ============================================================
[dev.deploy.parameters]
stack_name = "my-secure-app-dev"
region = "ap-south-1"
resolve_s3 = true
s3_prefix = "my-secure-app"
confirm_changeset = true
capabilities = "CAPABILITY_IAM"
profile = "my-aws-profile"
# Use single quotes to avoid escaping issues
# LambdaRoleArn must be provided - get this from your security/platform team
parameter_overrides = 'EnvironmentName="dev" SecretName="my-app-secrets-dev" LambdaRoleArn="arn:aws:iam::123456789012:role/MyLambdaRole" AllowedOrigin="*"'

# ============================================================
# PROD ENVIRONMENT
# ============================================================
[prod.deploy.parameters]
stack_name = "my-secure-app-prod"
region = "ap-south-1"
resolve_s3 = true
s3_prefix = "my-secure-app"
confirm_changeset = true
capabilities = "CAPABILITY_IAM"
profile = "my-aws-prod-profile"
# Restrict CORS in production
parameter_overrides = 'EnvironmentName="prod" SecretName="my-app-secrets-prod" LambdaRoleArn="arn:aws:iam::123456789012:role/MyLambdaRole-Prod" AllowedOrigin="https://myapp.example.com"'
```

---

## Deployment Commands

```bash
# Build the application
sam build

# Deploy to DEV
sam deploy --config-env dev

# Deploy to PROD
sam deploy --config-env prod
```

---

## Quick Reference

| Concept | Secure Approach |
|---------|-----------------|
| API Keys | AWS Secrets Manager + `{{resolve:...}}` |
| IAM Roles | **Do NOT create inline** - reference external ARN |
| CORS | Specific origin in prod, `*` only in dev |
| Parameters | `NoEcho: true` for sensitive values |
| Logging | CloudWatch with scoped permissions |
| VPC | Optional, use conditions for flexibility |

---

## See Also
- [Building Detection V2 Template](file:///d:/POCs/Building_detection/V1/V2/backend/template.yaml) - Real-world example with VPC, DynamoDB, and multi-function setup.
